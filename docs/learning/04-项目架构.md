# 04. 项目架构

理解项目的整体架构设计，是学习代码的基础。

## 🏗️ 架构概览

Image Resolver 采用**分层架构**和**MVVM 模式**，将界面、业务逻辑和数据分离。

```
┌─────────────────────────────────────────┐
│           Presentation Layer            │
│         (UI / 表示层)                    │
│  ┌─────────────┐      ┌──────────────┐ │
│  │ MainWindow  │      │   App.xaml   │ │
│  │   (XAML)    │      │  (入口点)     │ │
│  └─────────────┘      └──────────────┘ │
└─────────────────────────────────────────┘
                    ↕ (数据绑定)
┌─────────────────────────────────────────┐
│          Business Logic Layer          │
│         (业务逻辑层)                     │
│  ┌──────────────┐    ┌───────────────┐ │
│  │ImageInfo     │    │ CsvExport     │ │
│  │Service       │    │ Service       │ │
│  └──────────────┘    └───────────────┘ │
└─────────────────────────────────────────┘
                    ↕ (使用)
┌─────────────────────────────────────────┐
│            Data Layer                   │
│         (数据层)                         │
│  ┌──────────────┐    ┌───────────────┐ │
│  │  ImageInfo   │    │   ExifLib     │ │
│  │   (Model)    │    │  (第三方库)    │ │
│  └──────────────┘    └───────────────┘ │
└─────────────────────────────────────────┘
```

## 📦 三层架构

### 1. 表示层 (Presentation Layer)

**职责**: 用户界面和交互

**组件**:
- `App.xaml` / `App.xaml.cs`: 应用程序入口
- `MainWindow.xaml` / `MainWindow.xaml.cs`: 主窗口

**特点**:
- 使用 XAML 定义界面
- 使用 C# 处理用户交互
- 通过数据绑定连接业务逻辑

### 2. 业务逻辑层 (Business Logic Layer)

**职责**: 处理业务逻辑和数据转换

**组件**:
- `ImageInfoService`: 图片信息提取服务
- `CsvExportService`: CSV 导出服务

**特点**:
- 独立于 UI，可复用
- 异步处理，不阻塞 UI
- 错误处理和日志记录

### 3. 数据层 (Data Layer)

**职责**: 数据模型和存储

**组件**:
- `ImageInfo`: 图片信息数据模型
- 第三方库（ExifLib、CsvHelper）

**特点**:
- 纯数据类，无业务逻辑
- 定义数据结构
- 提供数据访问接口

## 🎯 MVVM 模式

MVVM (Model-View-ViewModel) 是 WinUI 3 推荐的设计模式。

### Model（模型）
- **ImageInfo**: 数据模型，存储图片信息

### View（视图）
- **MainWindow.xaml**: XAML 界面定义
- 只负责显示，不包含业务逻辑

### ViewModel（视图模型）
- **ImageInfoViewModel**: 在 `MainWindow.xaml.cs` 中实现
- 连接 View 和 Model
- 处理 UI 逻辑和数据绑定

### 数据绑定示例

```xml
<!-- View (XAML) -->
<TextBlock Text="{Binding FileName}" />
```

```csharp
// ViewModel (C#)
public string FileName => ImageInfo.FileName;
```

## 🔄 数据流

### 用户操作流程

```
用户点击"选择文件夹"
    ↓
MainWindow.xaml.cs (事件处理)
    ↓
ImageInfoService.ProcessImagesAsync()
    ↓
读取图片文件 → 提取信息 → 创建 ImageInfo
    ↓
返回 List<ImageInfo>
    ↓
创建 ImageInfoViewModel 列表
    ↓
绑定到 UI (ItemsControl)
    ↓
界面显示图片列表
```

### 图片处理流程

```
选择文件夹
    ↓
扫描文件（过滤图片格式）
    ↓
异步处理每张图片：
  ├─ 读取图片尺寸（Windows.Graphics.Imaging）
  ├─ 读取 EXIF 数据（ExifLib）
  └─ 创建 ImageInfo 对象
    ↓
返回所有图片信息
    ↓
更新 UI
```

## 🧩 核心组件详解

### 1. App.xaml.cs

**作用**: 应用程序入口点

**关键代码**:
```csharp
protected override void OnLaunched(LaunchActivatedEventArgs args)
{
    m_window = new MainWindow();
    m_window.Activate();
}
```

**说明**: 
- 应用启动时创建主窗口
- 处理应用生命周期事件

### 2. MainWindow

**作用**: 主窗口，包含所有 UI 和交互逻辑

**结构**:
- XAML: 定义界面布局
- C#: 处理事件和数据绑定

### 3. ImageInfoService

**作用**: 图片信息提取服务

**主要方法**:
- `ProcessImagesAsync()`: 批量处理图片
- `ProcessImageAsync()`: 处理单张图片

### 4. CsvExportService

**作用**: CSV 导出服务

**主要方法**:
- `ExportToCsvAsync()`: 导出图片信息到 CSV

## 🔗 组件间关系

```
App
 └─ MainWindow
     ├─ ImageInfoService (处理图片)
     ├─ CsvExportService (导出CSV)
     └─ ImageInfoViewModel (数据绑定)
         └─ ImageInfo (数据模型)
```

## 📊 设计原则

### 1. 单一职责原则
- 每个类只负责一个功能
- `ImageInfoService` 只处理图片
- `CsvExportService` 只处理导出

### 2. 依赖倒置
- UI 依赖服务接口，不依赖具体实现
- 便于测试和扩展

### 3. 异步优先
- 所有 I/O 操作使用异步方法
- 不阻塞 UI 线程

### 4. 错误隔离
- 单个图片错误不影响整体处理
- 静默处理异常，继续处理其他图片

## 🎓 架构优势

1. **可维护性**: 代码结构清晰，易于修改
2. **可测试性**: 业务逻辑独立，便于单元测试
3. **可扩展性**: 易于添加新功能
4. **可复用性**: 服务层可在其他项目复用

## 📚 下一步

- 了解项目结构 → [05-项目结构](./05-项目结构.md)
- 学习设计模式 → [06-设计模式](./06-设计模式.md)
- 深入代码实现 → [11-UI实现详解](./11-UI实现详解.md)

---

**继续学习**: [05-项目结构](./05-项目结构.md) →

